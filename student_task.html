<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>LinguaListen Â· Task</title>

  <style>
    body { font-family: Arial; padding: 20px; background:#fff7ef; }
    h1 { color: #ff7d2d; }
    textarea { width: 100%; height: 120px; margin-top: 10px; }
    button { padding: 10px; margin: 5px; font-size: 16px; }
    #sentenceBox { padding:15px; background:white; border-radius:10px; margin:10px 0; }
  </style>
</head>
<body>

<h1>ğŸ§ å­¦ä¹ ä»»åŠ¡ Student Task</h1>

<p>å­¦ç”Ÿï¼š<b id="studentName"></b></p>

<div id="taskInfo">åŠ è½½ä¸­ Loading...</div>

<div id="sentenceBox">
  <h3 id="sentenceText">å¥å­åŠ è½½ä¸­...</h3>
</div>

<textarea id="answerBox" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„å†…å®¹ Type what you heardâ€¦"></textarea>

<button onclick="submitDictation()">æäº¤å¬å†™ Submit Dictation</button>

<p id="result"></p>

<button onclick="nextSentence()">â¡ï¸ ä¸‹ä¸€å¥ Next</button>

<script>
const API = "https://lingualisten-backend.onrender.com";

let student = localStorage.getItem("student");
let task_id = localStorage.getItem("task_id");

if(!student) window.location.href = "login.html";

document.getElementById("studentName").textContent = student;

let task = null;
let index = 0;
let sentences = [];

// 1) åŠ è½½ä»»åŠ¡
async function loadTask() {
  const res = await fetch(`${API}/tasks/${task_id}`);
  task = await res.json();
  sentences = task.sentences;

  document.getElementById("taskInfo").innerHTML =
    `<h2>${task.title}</h2><p>é¢˜å‹ï¼š${task.modes.join(", ")}</p>`;

  showSentence();
}

function showSentence() {
  if (index >= sentences.length) {
    document.getElementById("sentenceText").textContent = "ğŸ‰ æ­å–œå®Œæˆå…¨éƒ¨å¥å­ All sentences done!";
    return;
  }
  document.getElementById("sentenceText").textContent =
    sentences[index].text;

  document.getElementById("answerBox").value = "";
  document.getElementById("result").textContent = "";
}

// 2) æäº¤å¬å†™
async function submitDictation() {
  const expected = sentences[index].text;
  const text = document.getElementById("answerBox").value;

  const payload = {
    user_id: student,
    task_id: Number(task_id),
    sentence_id: sentences[index].id,
    expected,
    text
  };

  const res = await fetch(`${API}/submit/dictation`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  
  document.getElementById("result").textContent =
    `å¾—åˆ† Score: ${data.score}`;
}

// 3) ä¸‹ä¸€å¥
function nextSentence() {
  index++;
  showSentence();
}

loadTask();
</script>

</body>
</html>
