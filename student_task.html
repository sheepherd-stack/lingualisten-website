<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Student Task</title>

  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #fffdf7;
    }
    h2 { color: #ff8c3a; }

    #sentenceBox {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
    }

    textarea, input {
      width: 100%;
      font-size: 16px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 8px;
    }

    button {
      background: #ff8c3a;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      cursor: pointer;
    }

    .result {
      background: #e2ffe2;
      padding: 10px;
      border-radius: 6px;
      margin-top: 15px;
      border: 1px solid #99d799;
    }
  </style>
</head>
<body>

<h2>ğŸ§ Task Practice</h2>
<p id="taskTitle"></p>

<div id="sentenceBox">
  <p id="sentenceText">åŠ è½½ä¸­...</p>
</div>

<div id="modeBox"></div>

<p id="result"></p>

<button onclick="nextSentence()">ä¸‹ä¸€å¥ â–¶</button>

<script>
const API = "https://lingualisten-backend.onrender.com";

// ä» localStorage è·å–ä»»åŠ¡ä¿¡æ¯
const username = localStorage.getItem("student_username");
const taskId = localStorage.getItem("current_task");

let task = null;
let index = 0;

// åŠ è½½ä»»åŠ¡
async function loadTask() {
  let t = await fetch(API + "/tasks/" + taskId).then(r => r.json());
  task = t;

  document.getElementById("taskTitle").innerHTML =
    `ä»»åŠ¡ï¼š${t.title} | æ¨¡å¼ï¼š${t.modes.join(", ")}`;

  loadSentence();
}

// æ˜¾ç¤ºå½“å‰å¥å­
function loadSentence() {
  if (index >= task.sentences.length) {
    document.getElementById("sentenceText").innerHTML = "ä»»åŠ¡å®Œæˆï¼ğŸ‰";
    document.getElementById("modeBox").innerHTML = "";
    return;
  }

  const s = task.sentences[index];
  document.getElementById("sentenceText").innerHTML = s.text;

  buildModeUI(s);
}

// æ ¹æ®ä»»åŠ¡æ¨¡å¼ç”Ÿæˆ UI
function buildModeUI(sentence) {
  let html = "";

  if (task.modes.includes("dictation")) {
    html += `
      <h3>âœï¸ å¬å†™ Dictation</h3>
      <textarea id="dictInput" rows="3" placeholder="è¾“å…¥ä½ å¬åˆ°çš„å†…å®¹"></textarea>
      <button onclick="submitDictation(${sentence.id}, '${sentence.text}')">æäº¤</button>
    `;
  }

  if (task.modes.includes("retell")) {
    html += `
      <h3>ğŸ“– Retell å¤è¿°</h3>
      <textarea id="retellInput" rows="3" placeholder="ç”¨ä½ è‡ªå·±çš„è¯å¤è¿°è¿™å¥è¯"></textarea>
      <button onclick="submitRetell(${sentence.id}, '${sentence.text}')">æäº¤</button>
    `;
  }

  if (task.modes.includes("summary")) {
    html += `
      <h3>ğŸ“ Summary æ€»ç»“</h3>
      <textarea id="summaryInput" rows="3" placeholder="æ€»ç»“è¿™å¥è¯çš„å«ä¹‰"></textarea>
      <button onclick="submitSummary(${sentence.id}, '${sentence.text}')">æäº¤</button>
    `;
  }

  if (task.modes.includes("shadowing")) {
    html += `
      <h3>ğŸ¤ Shadowing è·Ÿè¯»</h3>
      <button onclick="submitShadowing(${sentence.id})">æ¨¡æ‹Ÿæäº¤ï¼ˆä¸´æ—¶ç‰ˆï¼‰</button>
    `;
  }

  document.getElementById("modeBox").innerHTML = html;
}

// æäº¤å¬å†™
async function submitDictation(sid, expected) {
  let txt = document.getElementById("dictInput").value.trim();
  if (!txt) return alert("è¯·è¾“å…¥å†…å®¹");

  let payload = {
    user_id: username,
    task_id: taskId,
    sentence_id: sid,
    expected: expected,
    text: txt
  };

  let res = await fetch(API + "/submit/dictation", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  let out = await res.json();

  document.getElementById("result").innerHTML =
    `<div class="result">å¾—åˆ†ï¼š${out.score}</div>`;
}

// æäº¤å¤è¿°
async function submitRetell(sid, reference) {
  let txt = document.getElementById("retellInput").value.trim();
  if (!txt) return alert("è¯·è¾“å…¥å†…å®¹");

  let res = await fetch(API + "/submit/retell", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      user_id: username,
      task_id: taskId,
      sentence_id: sid,
      reference: reference,
      text: txt
    })
  });

  let out = await res.json();
  document.getElementById("result").innerHTML =
    `<div class="result">å¾—åˆ†ï¼š${out.score}</div>`;
}

// æäº¤æ€»ç»“
async function submitSummary(sid, reference) {
  let txt = document.getElementById("summaryInput").value.trim();
  if (!txt) return alert("è¯·è¾“å…¥å†…å®¹");

  let res = await fetch(API + "/submit/summary", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      user_id: username,
      task_id: taskId,
      reference: reference,
      text: txt
    })
  });

  let out = await res.json();
  document.getElementById("result").innerHTML =
    `<div class="result">å¾—åˆ†ï¼š${out.score}</div>`;
}

// è·Ÿè¯»ï¼ˆä¸´æ—¶ç‰ˆï¼‰
async function submitShadowing(sid) {
  alert("æœªæ¥å¯ä¸Šä¼ è¯­éŸ³ï¼Œç°åœ¨æ˜¯æ¨¡æ‹Ÿæ‰“åˆ†");
  let res = await fetch(API + "/submit/shadowing", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      user_id: username,
      task_id: taskId,
      sentence_id: sid,
      duration_ms: 1100,
      reference_ms: 1000
    })
  });

  let out = await res.json();
  document.getElementById("result").innerHTML =
    `<div class="result">å¾—åˆ†ï¼š${out.score}</div>`;
}

// ä¸‹ä¸€å¥
function nextSentence() {
  index++;
  loadSentence();
}

loadTask();
</script>

</body>
</html>
